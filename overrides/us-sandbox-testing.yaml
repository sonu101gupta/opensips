replicas: 1
app: opensips-mrcp
namespace: opensips-testing

image:
  repository: 536612919621.dkr.ecr.ap-south-1.amazonaws.com/testing/sonu
  tag: 3.6.2
  pullPolicy: Always
    
resources: 
  limits:
    cpu: 1000m
    memory: 1000Mi
  requests:
    cpu: 250m
    memory: 250Mi

env:
  CLIENT: sandbox
  LOG_LEVEL: 3
  DEBUG_MODE: "yes"
  NUM_CHILDREN: "4"
  DIALOG_TIMEOUT: "1800"

enableReadinessProbe: true
readinessProbeInitialDelay: 15
readinessProbeInterval: 10
readinessProbeTimeout: 5

enableLivenessProbe: true
livenessProbeInitialDelay: 30
livenessProbeInterval: 30
livenessProbeTimeout: 3

nodeSelector: {}
tolerations: []
affinity: {}

volumeMounts:
 - name: opensips-mrcp-configmap
   mountPath: /usr/src/opensips-3.6.2/scripts/dbtext/opensips/load_balancer
   subPath: load_balancer
 - name: opensips-cfg-configmap
   mountPath: /usr/src/opensips-3.6.2/configs/opensips.cfg.template
   subPath: opensips.cfg.template

configMaps:
  load_balancer: |-
    id(int,auto) group_id(int) dst_uri(string) resources(string) probe_mode(int) attrs(string,null) description(string,null)
    1:1:sip\:0.0.0.0\:9060:pstn=10000:2::
   
  opensips_cfg_template: |-
    ####### Global Parameters #########

    # -3 - Alert level
    # -2 - Critical level
    # -1 - Error level
    #  1 - Warning level
    #  2 - Notice level
    #  3 - Info level
    #  4 - Debug level
    
    log_level=${LOG_LEVEL}
    log_stderror=yes
    log_facility=LOG_LOCAL0

    debug_mode=${DEBUG_MODE}
    auto_aliases=no

    # UDP and TCP transports are built into core in 3.6  
    # Use socket= as listen= is deprecated in 3.6
    socket=udp:0.0.0.0:9060
    socket=tcp:0.0.0.0:9060

    tcp_max_connections = 2048
    udp_workers = 8
    tcp_workers = 8

    ####### Modules Section ########
    
    #set module path
    mpath="/usr/local/lib64/opensips/modules/"

    #### Built-in transport protocol modules (no .so extension)
    loadmodule "proto_udp"
    loadmodule "proto_tcp"

    ### Statistics module
    loadmodule "statistics.so"
    modparam("statistics", "variable", "register_counter")
    modparam("statistics", "variable", "active_calls/no_reset")

    #### SIGNALING module
    loadmodule "signaling.so"

    #### StateLess module
    loadmodule "sl.so"

    #### Options Module
    loadmodule "options.so"

    #### Transaction Module
    loadmodule "tm.so"
    modparam("tm", "fr_timeout", 3)
    modparam("tm", "fr_inv_timeout", 30)
    modparam("tm", "restart_fr_on_each_reply", 0)
    modparam("tm", "onreply_avp_mode", 1)

    #### Record Route Module
    loadmodule "rr.so"
    modparam("rr", "append_fromtag", 0)

    #### MAX ForWarD module
    loadmodule "maxfwd.so"

    #### SIP MSG OPerationS module
    loadmodule "sipmsgops.so"

    #### FIFO Management Interface
    loadmodule "mi_fifo.so"
    modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo")
    modparam("mi_fifo", "fifo_mode", 0666)

    #### DBTEXT module
    loadmodule "db_text.so"

    loadmodule "dispatcher.so"
    modparam("dispatcher", "db_url", "text:///usr/src/opensips-3.6.2/scripts/dbtext/opensips")

    #### ACCounting module
    loadmodule "acc.so"

    # what special events should be accounted ?
    modparam("acc", "early_media", 0)
    modparam("acc", "report_cancels", 0)
    modparam("acc", "detect_direction", 0)

    #### DIALOG module
    loadmodule "dialog.so"
    modparam("dialog", "dlg_match_mode", 1)
    modparam("dialog", "default_timeout", 1800)  # 30 minutes
    modparam("dialog", "db_mode", 2)
    modparam("dialog", "db_url", "text:///usr/src/opensips-3.6.2/scripts/dbtext/opensips")
    modparam("dialog", "enable_stats", 1)

    #### LOAD BALANCER module
    loadmodule "load_balancer.so"
    modparam("load_balancer", "db_url", "text:///usr/src/opensips-3.6.2/scripts/dbtext/opensips")
    modparam("load_balancer", "probing_method", "OPTIONS")
    modparam("load_balancer", "probing_interval", 10)

    #### transport protocols
    loadmodule "rtpengine.so"

    #### USeR LOCation module
    loadmodule "usrloc.so"
    modparam("usrloc", "nat_bflag", "NAT")
    modparam("usrloc", "working_mode_preset", "single-instance-no-db")

    #### REGISTRAR module
    loadmodule "registrar.so"
    modparam("registrar", "tcp_persistent_flag", "TCP_PERSISTENT")

    #### Registrant module
    loadmodule "uac_auth.so"
    loadmodule "uac_registrant.so"
    modparam("uac_registrant", "db_url", "text:///usr/src/opensips-3.6.2/scripts/dbtext/opensips")

    #### PRometheus module
    loadmodule "httpd.so"
    loadmodule "prometheus.so"

    modparam("httpd", "port", 32762)
    modparam("prometheus", "statistics", "get_statistics all")

    ####### Routing Logic ########

    route{
            setuser("");
            if ($rm=="OPTIONS") {
                sl_send_reply(200,"OK");
                exit;
            }

            if (!mf_process_maxfwd_header(10)) {
                    sl_send_reply(483,"Too Many Hops");
                    exit;
            }

            if (has_totag()) {
            # handle hop-by-hop ACK (no routing required)
            if ( $rm=="ACK" && t_check_trans() ) {
              t_relay();
              exit;
            }

            # sequential request withing a dialog should
            # take the path determined by record-routing
            if ( !loose_route() ) {
              # we do record-routing for all our traffic, so we should not
              # receive any sequential requests without Route hdr.
              send_reply(404,"Not here");
              exit;
            }
        
            # validate the sequential request against dialog
            if ( $DLG_status!=NULL && !validate_dialog() ) {
              xlog("In-Dialog $rm from $si (callid=$ci) is not valid according to dialog\n");
              ## exit;
            }
            
            if ($rm=="BYE") {
              # do accounting even if the transaction fails
              do_accounting("log","failed");
            }
    
            # route it out to whatever destination was set by loose_route()
            # in $du (destination URI).
            route(RELAY);
            exit;
          }
    
            #### INITIAL REQUESTS

            # handle cancel and re-transmissions
            if ( $rm=="CANCEL" ) {
              if ( t_check_trans() )
                t_relay();
                exit;
            }

            t_check_trans();

          # preloaded route checking
          if (loose_route()) {
            xlog("L_ERR",
              "Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]");
            if (!is_method("ACK"))
              send_reply(403,"Preload Route denied");
            exit;
          }

          # record routing
          record_route();

          do_accounting("log");

            if ($rm=="INVITE") {
                if (!lb_start_or_next(1,"pstn","1")) {
                xlog("L_ERR","Load Balance failed");
                        send_reply(503,"Service Unavailable");
                        exit;
                }
            }

            else if ($rm=="REGISTER") {
              if (!ds_select_dst(1, 0)) {
                send_reply(503,"Service Unavailable");
                  exit;
              }
            }

            t_on_failure("GW_FAILOVER");

            # route the request
            if (!t_relay()) {
                sl_reply_error();
            }
            exit;
        }

        route[RELAY] {
            if (!t_relay()) {
                sl_reply_error();
            }
            exit;
        }


        failure_route[GW_FAILOVER] {
            xlog("L_ERR", "Failure route");
            if (t_was_cancelled()) {
                exit;
            }

            # failure detection with redirect to next available trunk
            if (t_check_status("(408)|([56][0-9][0-9])")) {
                xlog("Failed trunk $rd/$du detected \n");
    
                # Disable the last LB destination which failed
                lb_disable_dst();
                if ( lb_next() ) {
                    t_on_failure("GW_FAILOVER");
                    t_relay();
                    exit;
                }
                send_reply(500,"All GW are down");
            }
        }


        local_route {
            if ($rm=="BYE" && $DLG_dir=="UPSTREAM") {
                acc_log_request("200 Dialog Timeout");
            }
        }

